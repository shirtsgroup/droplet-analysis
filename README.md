# droplet-analysis
Tools for building and analyzing nanoscale droplets.

This simulation has been created my Mitchell Slovin (mrs7wp@virginia.edu) and Michael Shirts (michael.shirts@virginia.edu) as a part of the Shirts Research Group at the University of Virginia. It is intended to analyze static and dynamic contact angles for a fluid between two smooth or textured solid surfaces on the nanoscale. 

1) 	Ensure that your system has Gromacs, VMD, UNIX, Python 2.7, scipy, and numpy installed. 

2) 	Ensure that your working directory contains the files ‘AnalyzeResults.py,’ ‘CalculateVelocity.py,’ ‘ProcessResults.py,’ ‘RunSimulation.py,’ and ‘SetupSystem.py.’ Change the path variables in these files to match the location of the directory containing the files on your system. 

3) 	The 'SetupSystem.py' file will generate the initial system configuration that will be used for the simulation. Open this file and view the second section of the file titled 'Parameters', which will allow numerous system features to be set. Only these parameters should be changed and no other aspects of the file should typically be modified (except the 'Files' section, which contains parameters that may need to be altered in order to modify simulation conditions). All parameters are clearly documented with the specific aspect of the system that they set. Adjust any parameters in this section to create the initial system configuration that is desired. The system dimensions, texture, and wall epsilon (adjusts hydrophobicity or hydrophilicity) are of particular importance. Sigma and epsilon for the walls can be specified both explicitly and as a reduced wall-fluid value. There are several parameters in this section that should not be changed and they are clearly marked with '(DO NOT CHANGE!)'. To understand more about the system being generated, read the comments for this file. When this file is eventually run (step 6), it will write all of the parameters used to the 'Results.txt' output file so that the parameters used in setting up the system for the simulation can be retained in a single file with the results of the simulation.

This file will also generate a subdirectory within the working directory titled 'simulation' that will be used to contain all of the simulation input and output files. The 'SetupSystem.py' file will generate nine simulation input files within the 'simulation' directory titled 'makeindex.txt', 'system.gro', 'system.top', 'minimize.mdp', 'minimize.txt', 'nvt.mdp', 'nvt.txt', 'simulation.mdp', and 'simulation.txt'. These files are generated within the 'Files' section of the 'SetupSystem.py' file and aspects of this section can be altered to change various simulation conditions set by these files, which will be discussed later.  

The initial fluid arrangement will form a box that occupies the specified spacing between the innermost wall texture in a body-centered cubic arrangement. The fluid will also fill the width of the initial system completely. The length of the system will be filled about the center of the walls to the specified fraction of the wall length. The initial closest spacing between neighboring fluid atoms can be set in terms of sigma. Although the lowest energy spacing is 2^(1/6) sigma, a value of approximately 1.15 sigma should be used. Periodic boundary conditions are perpendicular to and located immediately against the edges of each wall.

The boolean 'roughness' must be 'True' or no roughness will be generated regardless of what other variables are. Parameters can be altered in order to generate both patterned and random chemical and or physical roughness. Numerous different types of atoms can be specified and used in the chemical roughness. Each pillar of physical roughness will be assigned a type of atom. The likelihood of a wall atom being selected compared to the other types of wall atoms for a particular pillar can be specified. Detailed information about how to add atoms and set their chemical roughness characteristics is provided in the comments of the 'Parameters' section of the 'SetupSystem.py' file. For random physical roughness characteristics including the radius, height, and spacing of pillars, a range of values can be provided and the values for individual pillars will be selected randomly within this range. Patterned physical roughness parameters including the pillar radius, height, and spacing can be set so that every pillar in the system has the same respective value. The walls will move apart from one another to maintain the specified spacing between the innermost wall roughness and fluid atoms will be generated to fill this spacing. Random roughness patterns will be different on both walls in order to prevent symmetry but will still obey the ranges specified for each value. Roughness parameters must be specified as to prevent pillars from overlapping. If pillars overlap, multiple atoms will be generated at the same location and the simulation will fail. Note that there are many different combinations of roughness features and, although many have been extensively tested and used, others have not. Some results may be unexpected and it is always a good idea to examine the results before running the full simulation. Some guessing and checking may be required to obtain the desired results.

After changes have been made, save and run this file. Examine the initial system with VMD in addition to all generated .mdp and .txt files to ensure they have been created as desired. The 'SetupSystem.py' file will be run again automatically when the simulation is run but it is important to ensure the initial system and parameters are correct before using substantial computational resources to run the simulation. Remove the 'simulation' subdirectory after you are done examining its contents so that it does not interfere with the simulation when run. Keep in mind that any changes to any files generated by 'SetupSystem.py' must be made from within the 'SetupSystem.py' file and not within any of the files themselves. This is because they will be created by 'SetupSystem.py' every time the simulation is run. 

The 'simulation' directory contains all initial input files that will be used to run the simulation. The files 'system.gro' and 'system.top' do not need to be changed as 'SetupSystem.py' will modify these files to produce the specified initial system configuration. The file 'minimize.mdp' will set various conditions for the energy minimization portion of the simulation. It has been set to default parameters and it is recommended that they remain as these values. The file 'minimize.txt' sets the options for a file that is generated following the energy minimization portion of the simulation. This file will contain information about the energy minimization that can be used to generate plots. By default, this file includes the potential energy and pressure as a function of time step. Unless you require plots of different data, it is recommended that this file remain unchanged. The files 'nvt.mdp' and 'nvt.txt' serve the same purpose as 'minimize.mdp' and 'minimize.txt' respectively but are for the NVT ensemble. By default, 'nvt.txt' includes output for the system potential energy, temperature, and pressure as a function of time step. The file 'simulation.mdp' serves the same purpose as 'minimize.mdp' but is for the production simulation. The file 'simulation.txt' should not be altered and is set by default to include atoms for the entire system in the simulation output files as opposed to just specific types of atoms. The three mdp files set important aspects of the simulation including: the length of a time step, the number of time steps, the temperature, periodic boundary conditions, output frequency, the type of temperature coupling, and, in the case of 'simulation.mdp' the fluid velocity. As a reminder, in order to alter any of the options in any of these files, make changes directly to the 'Files' section of the 'SetupSystem.py' file.

4) 	Open the ‘ProcessResults.py' and ‘AnalyzeResults.py’ files. Again, only parameters in the second section of the file titled 'Parameters' should be changed. Sigma should be set to exactly match the value of the sigma_fluid parameter in the 'SetupSystem.py' file and sigma_wall should be set to exactly match the value in the 'SetupSystem.py' file. All other parameters can be changed to set how the contact angles are calculated. The parameter 'density_length' sets the number of sigmas that comprise the pixel side length. The side length of a pixel should be optimized for the density distribution of the specified contiguous subsample size. The parameter 'density_length' will also set the width of a histogram bin used to center the fluid atoms of each sampled configuration by density peak. The parameter dsigma sets the fraction of total fluid height between the innermost atoms of each wall that will be considered in the contact angle calculations. The first two sigmas of height above each innermost wall roughness are not considered in calculations due to unpredictable fluid-wall interactions but the correct fraction of total fluid height from both walls will still be considered. Sampled configurations (individual .gro files from within the concatenated 'analyze.gro' file) will be analyzed in contiguous subsamples so that a measure of uncertainty can be obtained. The number of sampled configurations in a contiguous subsample can be specified by the parameter 'fileSectionSize'. The time step and frequency of sampling are also required so correct velocities can be determined.

The simulation will produce sampled configurations, which are simply concatenated .gro files contained in one file titled 'analyze.gro' that will be located in the 'simulation' directory. ‘ProcessResults.py' first loads and analyzes the simulation data. This generates a processed results file titled ‘Data.pkl,’ which will be located in the ‘simulation’ directory. This will contain sampling box distributions for each contiguous subsample in addition to a variety of other data. ’AnalyzeResults.py’ will load this processed data file and perform contact angle calculations. Following these calculations, ‘AnalyzeResults.py’ will append the results to the ‘Results.txt’ file. Finally, all contact angle parameters used in analyzing the system are also written to the 'Results.txt' file along with the contact angle calculation results. This ensures the simulation and analysis conditions are well documented for a particular result. 

5)	Save any changes made to ‘ProcessResults.py' and ‘AnalyzeResults.py’ and open the 'RunSimulation.py' file. This file will run all components of the simulation automatically and generate output files in the correct locations. Ensure base_path and gmx_path are correctly set to the path of the directory on your system and your system GROMACS installation respectively. Also, ensure the number of cores that will be utilized by GROMACS to run the simulation is correctly set. Regardless of whether you are running the simulation on a computing cluster or a local computer, ensure that the number of cores being utilized is set to a value less than or equal to the number of cores available. Save all files and close all files except the 'RunSimulation.py' file. 

6) 	Run the 'RunSimulation.py' file. Note this will perform all simulation and analysis steps and may take substantial amounts of time depending on the parameters chosen and the computer being used. The current step of the simulation will be displayed periodically but be patient as the simulation runs. The UNIX and GROMACS commands that will be run by 'RunSystem.py' can be found by looking at the comments on the 'Main' section of the file. The steps that will be run are as follows:

1. Make the 'simulation' directory within the directory and change directories to that directory
2. Run the system setup file to generate the desired initial system (and all other input files required for the simulation in addition to the 'Results.txt' output file)
3. Make an index file from the 'system.gro' file
4. Run the energy minimization steps
5. Run the NVT ensemble steps
6. Run the production simulation steps
7. Obtain sampled configurations from the simulation steps in the form of the concatenated 'analyze.gro' file
8. Run the compute contact angle calculation files (this will add to the 'Results.txt' file in the 'simulation' directory and generate the 'Data.pkl' file)
9. Delete the initial simulation files, which require a large amount of storage space. This can be prevented by commenting the appropriate lines at the end of ‘RunSimulation.py.’By default this will move several simulation and results files out of the 'simulation' directory before deleting it.

7) 	The simulation results are now contained in many files. Contact angle data in addition to simulation and system parameters can be obtained by viewing the 'Results.txt' file. This file will contain all system setup and contact angle calculation parameters that are listed in the 'Parameter' section of each of the respective files. This file will also contain information about the simulation parameters contained in all three .mdp files and data generated from the contact angle calculations. Files with the extension .gro and .xtc (trajectories) can be loaded by VMD or other visualization software to visualize a component of the simulation. Log files can be analyzed to obtain information about various steps of the simulation as they are being run and after they have finished. The files 'minimize.xvg' and 'nvt.xvg' can be used to plot various types of information about the energy minimization and NVT ensemble components of the simulation respectively. The ‘Data.pkl’ file contains processed simulation results stored in a convenient and efficient format. 

8) Upon completing a simulation, the ‘CalculateVelocity.py’ file can be used to calculate the velocity of the fluid during the production simulation. Specify the correct file path to the ‘Data.pkl’ file in the ‘Parameters’ section of this file. Also specify the starting sampled configuration indices and the number of indices to analyze after each starting index. Running this file will plot and analyze data from the simulation to determine the fluid formation velocity. 